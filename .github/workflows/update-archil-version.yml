name: Update Archil Version

on:
  schedule:
    # Run every Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    outputs:
      updated: ${{ steps.check-update.outputs.updated }}
      old-version: ${{ steps.extract-versions.outputs.old-version }}
      new-version: ${{ steps.extract-versions.outputs.new-version }}
      pr-number: ${{ steps.create-pr.outputs.pr-number }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Configure git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Get current version
        id: get-current-version
        run: |
          CURRENT_VERSION=$(grep -oP 'version = "\K[^"]+' flake.nix | head -1)
          echo "current-version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Run update script
        id: check-update
        run: |
          echo "Running update.sh to check for new versions..."

          # Run update.sh and capture output
          if ./update.sh --verbose; then
            # Check if flake.nix was modified
            if git diff --quiet flake.nix; then
              echo "No updates available - already up to date"
              echo "updated=false" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "Update applied successfully"
              echo "updated=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "Error: update.sh failed"
            exit 1
          fi

      - name: Extract version information
        id: extract-versions
        if: steps.check-update.outputs.updated == 'true'
        run: |
          OLD_VERSION="${{ steps.get-current-version.outputs.current-version }}"
          NEW_VERSION=$(grep -oP 'version = "\K[^"]+' flake.nix | head -1)

          echo "old-version=$OLD_VERSION" >> $GITHUB_OUTPUT
          echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT

          echo "Version update: $OLD_VERSION â†’ $NEW_VERSION"

      - name: Create update branch
        if: steps.check-update.outputs.updated == 'true'
        run: |
          BRANCH_NAME="automated/update-archil-${{ steps.extract-versions.outputs.new-version }}"

          # Check if branch exists remotely
          if git ls-remote --exit-code --heads origin "$BRANCH_NAME" > /dev/null 2>&1; then
            echo "Branch $BRANCH_NAME already exists, checking it out"
            git fetch origin "$BRANCH_NAME"
            git checkout "$BRANCH_NAME"
            git merge --ff-only origin/main || git merge --strategy-option theirs origin/main
          else
            echo "Creating new branch $BRANCH_NAME"
            git checkout -b "$BRANCH_NAME"
          fi

          # Commit changes
          git add flake.nix
          git commit -m "chore: update archil to ${{ steps.extract-versions.outputs.new-version }}"

          # Push changes
          git push -u origin "$BRANCH_NAME"

          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create or update pull request
        id: create-pr
        if: steps.check-update.outputs.updated == 'true'
        run: |
          OLD_VERSION="${{ steps.extract-versions.outputs.old-version }}"
          NEW_VERSION="${{ steps.extract-versions.outputs.new-version }}"
          BRANCH_NAME="automated/update-archil-$NEW_VERSION"

          # Check if PR already exists
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --state open --json number --jq '.[0].number' || echo "")

          PR_TITLE="chore: update archil to $NEW_VERSION"
          PR_BODY="## Version Update

- **From**: $OLD_VERSION
- **To**: $NEW_VERSION
- **Update Script**: Automated via update.sh

## Validation

This PR includes the following automated checks:
- âœ… x86_64-linux build test
- âœ… aarch64-linux build test
- âœ… Nix flake validation
- âœ… Code formatting verification

## Auto-merge

This PR will automatically merge when all checks pass.

---
ðŸ¤– Generated by automated update workflow"

          if [ -n "$EXISTING_PR" ]; then
            echo "Updating existing PR #$EXISTING_PR"
            gh pr edit "$EXISTING_PR" --title "$PR_TITLE" --body "$PR_BODY"
            echo "pr-number=$EXISTING_PR" >> $GITHUB_OUTPUT
          else
            echo "Creating new PR"
            PR_NUMBER=$(gh pr create \
              --title "$PR_TITLE" \
              --body "$PR_BODY" \
              --base main \
              --head "$BRANCH_NAME" \
              --label "automated,dependencies" \
              | grep -oP 'pull/\K\d+' || echo "")

            if [ -n "$PR_NUMBER" ]; then
              echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT
              echo "Created PR #$PR_NUMBER"
            else
              echo "Failed to extract PR number"
              exit 1
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  validate-x86_64:
    needs: check-and-update
    if: needs.check-and-update.outputs.updated == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: automated/update-archil-${{ needs.check-and-update.outputs.new-version }}

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Build for x86_64-linux
        run: |
          echo "Building archil package for x86_64-linux..."
          nix build .#archil --print-build-logs

      - name: Test binary
        run: |
          echo "Testing archil binary..."
          ./result/bin/archil --version
          echo "Binary test successful"

  validate-aarch64:
    needs: check-and-update
    if: needs.check-and-update.outputs.updated == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: automated/update-archil-${{ needs.check-and-update.outputs.new-version }}

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            extra-platforms = aarch64-linux

      - name: Set up QEMU for aarch64 emulation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build for aarch64-linux
        run: |
          echo "Building archil package for aarch64-linux..."
          nix build .#archil --system aarch64-linux --print-build-logs

      - name: Test binary (emulated)
        run: |
          echo "Testing archil binary (emulated)..."
          # Note: Binary test in emulation may be slow or have limitations
          file ./result/bin/archil
          echo "Binary architecture validation successful"

  validate-flake:
    needs: check-and-update
    if: needs.check-and-update.outputs.updated == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: automated/update-archil-${{ needs.check-and-update.outputs.new-version }}

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Run flake check
        run: |
          echo "Running nix flake check..."
          nix flake check --print-build-logs
          echo "Flake validation successful"

  validate-formatting:
    needs: check-and-update
    if: needs.check-and-update.outputs.updated == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: automated/update-archil-${{ needs.check-and-update.outputs.new-version }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Check formatting
        id: check-fmt
        run: |
          echo "Checking code formatting..."
          if nix fmt -- --check .; then
            echo "Formatting is correct"
            echo "needs-fix=false" >> $GITHUB_OUTPUT
          else
            echo "Formatting issues detected"
            echo "needs-fix=true" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Auto-fix formatting
        if: steps.check-fmt.outputs.needs-fix == 'true'
        run: |
          echo "Auto-fixing formatting issues..."
          nix fmt

          # Configure git
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          # Check if there are changes to commit
          if ! git diff --quiet; then
            git add .
            git commit -m "style: auto-fix formatting"
            git push
            echo "Formatting fixes committed and pushed"
          else
            echo "No formatting changes needed after running nix fmt"
          fi

      - name: Verify formatting after fix
        if: steps.check-fmt.outputs.needs-fix == 'true'
        run: |
          echo "Verifying formatting after auto-fix..."
          nix fmt -- --check .
          echo "Formatting validation successful after auto-fix"

  auto-merge:
    needs: [check-and-update, validate-x86_64, validate-aarch64, validate-flake, validate-formatting]
    if: |
      needs.check-and-update.outputs.updated == 'true' &&
      needs.validate-x86_64.result == 'success' &&
      needs.validate-aarch64.result == 'success' &&
      needs.validate-flake.result == 'success' &&
      needs.validate-formatting.result == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Enable auto-merge
        run: |
          PR_NUMBER="${{ needs.check-and-update.outputs.pr-number }}"

          echo "Enabling auto-merge for PR #$PR_NUMBER"

          # Enable auto-merge with squash strategy
          gh pr merge "$PR_NUMBER" --auto --squash --delete-branch

          echo "Auto-merge enabled - PR will merge when all required checks pass"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
