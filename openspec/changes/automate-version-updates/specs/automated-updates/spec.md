# Capability: Automated Updates

## Overview

This capability provides automated version checking and updating for the Archil client package through a scheduled GitHub Actions workflow. The system detects new upstream versions, applies updates, validates changes across multiple architectures, and automatically merges approved updates.

## ADDED Requirements

### Requirement: Scheduled version checking

The system MUST check for new Archil versions on a weekly schedule.

#### Scenario: Weekly cron execution

**Given** the GitHub Actions workflow is configured
**When** Monday at 00:00 UTC arrives
**Then** the workflow triggers automatically
**And** executes the update.sh script to check for new versions

#### Scenario: Manual workflow trigger

**Given** a maintainer needs to check for updates immediately
**When** the maintainer triggers the workflow manually via GitHub UI
**Then** the workflow executes the same update process
**And** completes successfully or reports errors

### Requirement: Update detection and application

The system MUST detect when update.sh finds and applies a new version.

#### Scenario: New version available

**Given** update.sh finds a newer Archil version upstream
**When** the workflow executes update.sh
**Then** flake.nix is updated with new version and hashes
**And** the workflow detects changes via git status
**And** proceeds to PR creation

#### Scenario: Already up-to-date

**Given** the current version matches the upstream version
**When** the workflow executes update.sh
**Then** update.sh reports "Already up to date!"
**And** the workflow exits successfully without creating a PR
**And** no notifications are generated

#### Scenario: Upstream fetch failure

**Given** the upstream S3 install script is unreachable
**When** the workflow executes update.sh
**Then** update.sh exits with an error code
**And** the workflow job fails
**And** GitHub sends failure notification to repository maintainers

### Requirement: Pull request management

The system MUST create or update a pull request for version updates.

#### Scenario: First update PR

**Given** no open PR exists with title containing "Update archil to"
**When** update.sh successfully updates to version X.Y.Z-TIMESTAMP
**Then** a new PR is created with title "chore: update archil to X.Y.Z-TIMESTAMP"
**And** the PR description includes version change details
**And** the PR description includes links to validation jobs
**And** the PR is labeled with "automated" and "dependencies"

#### Scenario: Update existing PR

**Given** an open PR exists with title "chore: update archil to X.Y.Z-OLD"
**When** update.sh successfully updates to version X.Y.Z-NEW
**Then** the existing PR is updated with new commits
**And** the PR title is updated to "chore: update archil to X.Y.Z-NEW"
**And** the PR description is updated with new version details
**And** previous check runs are superseded by new check runs

#### Scenario: PR description format

**Given** a version update from 0.6.4-1760484228 to 0.6.5-1760590000
**When** the PR is created or updated
**Then** the PR description contains:
```markdown
## Version Update

- **From**: 0.6.4-1760484228
- **To**: 0.6.5-1760590000
- **Update Script**: Automated via update.sh

## Validation

This PR includes the following automated checks:
- âœ… x86_64-linux build test
- âœ… aarch64-linux build test
- âœ… Nix flake validation
- âœ… Code formatting verification

## Auto-merge

This PR will automatically merge when all checks pass.

---
ðŸ¤– Generated by automated update workflow
```

### Requirement: Multi-architecture validation

The system MUST validate package builds on all supported architectures.

#### Scenario: x86_64-linux build validation

**Given** flake.nix has been updated with new version and hashes
**When** the validation workflow runs
**Then** `nix build .#archil` executes on x86_64-linux GitHub runner
**And** the build completes successfully
**And** the binary is tested with `./result/bin/archil --version`
**And** the check is marked as passed

#### Scenario: aarch64-linux build validation

**Given** flake.nix has been updated with new version and hashes
**When** the validation workflow runs
**Then** `nix build .#archil` executes on aarch64-linux GitHub runner
**And** the build completes successfully
**And** the binary is tested with `./result/bin/archil --version`
**And** the check is marked as passed

#### Scenario: Build failure on any architecture

**Given** flake.nix has incorrect hash for aarch64
**When** the aarch64-linux build runs
**Then** the build fails with hash mismatch error
**And** the check is marked as failed
**And** auto-merge is prevented
**And** the PR remains open for manual review

### Requirement: Flake validation

The system MUST validate the flake structure and formatting.

#### Scenario: Flake check validation

**Given** flake.nix has been updated
**When** the validation workflow runs
**Then** `nix flake check` executes
**And** all flake outputs are validated
**And** the check passes successfully

#### Scenario: Format validation

**Given** flake.nix has been updated
**When** the validation workflow runs
**Then** `nix fmt --check` executes
**And** verifies alejandra/treefmt formatting
**And** the check passes if formatting is correct
**Or** the check fails if formatting issues exist

#### Scenario: Format auto-fix attempt

**Given** `nix fmt --check` detects formatting issues
**When** the check fails
**Then** the workflow runs `nix fmt` to auto-fix
**And** commits the formatting changes to the PR
**And** re-runs validation checks

### Requirement: Automated merge

The system MUST automatically merge PRs when all validations pass.

#### Scenario: All checks pass

**Given** an update PR exists with all checks
**When** all validation checks pass (x86_64 build, aarch64 build, flake check, format check)
**Then** the PR is automatically merged to main branch
**And** the PR is closed
**And** the remote branch is deleted
**And** a merge commit references the automated workflow

#### Scenario: Any check fails

**Given** an update PR exists
**When** at least one validation check fails
**Then** the PR remains open and unmerged
**And** the PR is marked as requiring attention
**And** maintainers are notified via GitHub notifications

#### Scenario: Merge conflict

**Given** an update PR exists
**When** main branch has conflicting changes
**Then** the PR cannot auto-merge
**And** the PR is labeled "merge-conflict"
**And** the workflow comments on the PR requesting manual resolution

### Requirement: Error handling and notifications

The system MUST gracefully handle errors and notify maintainers.

#### Scenario: Update script failure

**Given** update.sh encounters an error (e.g., curl failure)
**When** the workflow executes
**Then** the job fails with exit code from update.sh
**And** the workflow run shows failed status
**And** GitHub sends email notification to repository watchers

#### Scenario: Git operation failure

**Given** the workflow cannot commit or push changes
**When** a git operation fails
**Then** the workflow logs the error details
**And** the job fails with descriptive error message
**And** maintainers can diagnose from workflow logs

#### Scenario: Workflow permissions issue

**Given** the GITHUB_TOKEN lacks required permissions
**When** the workflow attempts to create a PR
**Then** the operation fails with permission error
**And** the workflow logs clear permission requirements
**And** the job fails with actionable error message

### Requirement: Idempotency and safety

The system MUST safely handle repeated executions.

#### Scenario: Multiple runs with no updates

**Given** the workflow runs twice in one week
**When** no new version is available in either run
**Then** both runs exit successfully
**And** no duplicate PRs are created
**And** no unnecessary API calls are made

#### Scenario: PR already exists with same version

**Given** an open PR exists for version X.Y.Z-TIMESTAMP
**When** the workflow runs and finds the same version
**Then** no new PR is created
**And** the existing PR is not modified
**And** the workflow exits successfully

#### Scenario: Race condition between manual and automated update

**Given** a maintainer manually updates to version X.Y.Z-NEW
**When** the scheduled workflow runs shortly after
**Then** update.sh detects "Already up to date"
**And** no conflicting PR is created
**And** the workflow respects the manual update
